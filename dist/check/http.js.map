{"version":3,"sources":["../../src/check/http.js"],"names":["module","exports","HTTPUrlCheck","Base","constructor","options","assertOptionValidity","run","url","response","method","set","pragma","expires","headers","timeout","interval","retry","then","ok","checkOutput","lastUpdated","Date","console","info","name","catch","error","message","validateOptions","Object","TypeError","Function","String","trim","undefined","validationResult","Error"],"mappings":"AAAA;;;AAIA;;AAEA;;AACA;;AACA;;;;AAEA;;;AAGAA,MAAM,CAACC,OAAP,GAAiB,MAAMC,YAAN,SAA2BC,aAA3B,CAAgC;AAC/C;;;;;;;AAOAC,EAAAA,WAAW,CAACC,OAAD,EAAU;AACnBH,IAAAA,YAAY,CAACI,oBAAb,CAAkCD,OAAlC;AACA,UAAMA,OAAN;AACD;AAED;;;;;;AAIA,QAAME,GAAN,GAAY;AACV,UAAMC,GAAG,GAAG,OAAO,KAAKH,OAAL,CAAaG,GAApB,KAA4B,UAA5B,GAAyC,KAAKH,OAAL,CAAaG,GAAb,EAAzC,GAA8D,KAAKH,OAAL,CAAaG,GAAvF;AACA,UAAMC,QAAQ,GAAG,MAAM,yBAAW,KAAKJ,OAAL,CAAaK,MAAb,IAAuB,KAAlC,EAAyCF,GAAzC,EACpBG,GADoB,CAChB;AACH,uBAAiB,qCADd;AAEHC,MAAAA,MAAM,EAAE,UAFL;AAGHC,MAAAA,OAAO,EAAE,GAHN;AAIH,SAAG,KAAKR,OAAL,CAAaS;AAJb,KADgB,EAOpBC,OAPoB,CAOZ,KAAKV,OAAL,CAAaW,QAPD,EAQpBC,KARoB,CAQd,KAAKZ,OAAL,CAAaY,KAAb,IAAsB,CARR,EASpBC,IAToB,CASf,MAAM;AACV,WAAKC,EAAL,GAAU,IAAV;AACA,WAAKC,WAAL,GAAmB,SAAnB;AACA,WAAKC,WAAL,GAAmB,IAAIC,IAAJ,EAAnB;AACAC,MAAAA,OAAO,CAACC,IAAR,CAAc,iBAAgB,KAAKnB,OAAL,CAAaoB,IAAK,aAAhD;AACD,KAdoB,EAepBC,KAfoB,CAebC,KAAD,IAAW;AAChB,WAAKR,EAAL,GAAU,KAAV;AACA,WAAKC,WAAL,GAAmBO,KAAK,CAACC,OAAzB;AACA,WAAKP,WAAL,GAAmB,IAAIC,IAAJ,EAAnB;AACAC,MAAAA,OAAO,CAACI,KAAR,CAAe,iBAAgB,KAAKtB,OAAL,CAAaoB,IAAK,aAAYE,KAAK,CAACC,OAAQ,EAA3E;AACD,KApBoB,CAAvB;AAsBA,WAAOnB,QAAP;AACD;AAED;;;;;;;AAKA,SAAOoB,eAAP,CAAuBxB,OAAvB,EAAgC;AAC9B,QAAI,CAAC,iBAAGyB,MAAH,EAAWzB,OAAX,CAAL,EAA0B;AACxB,aAAO,IAAI0B,SAAJ,CAAc,2BAAd,CAAP;AACD;;AACD,QAAI,CAAC,iBAAGC,QAAH,EAAa3B,OAAO,CAACG,GAArB,CAAD,KAA+B,CAAC,iBAAGyB,MAAH,EAAW5B,OAAO,CAACG,GAAnB,CAAD,IAA4B,CAACH,OAAO,CAACG,GAAR,CAAY0B,IAAZ,EAA5D,CAAJ,EAAqF;AACnF,aAAO,IAAIH,SAAJ,CAAc,8DAAd,CAAP;AACD;;AACD,QAAI1B,OAAO,CAACS,OAAR,KAAoBqB,SAApB,IAAiC,CAAC,iBAAGL,MAAH,EAAWzB,OAAO,CAACS,OAAnB,CAAtC,EAAmE;AACjE,aAAO,IAAIiB,SAAJ,CAAc,2CAAd,CAAP;AACD;;AACD,WAAO,IAAP;AACD;AAED;;;;;;;AAKA,SAAOzB,oBAAP,CAA4BD,OAA5B,EAAqC;AACnC,UAAM+B,gBAAgB,GAAGlC,YAAY,CAAC2B,eAAb,CAA6BxB,OAA7B,CAAzB;;AACA,QAAI+B,gBAAgB,YAAYC,KAAhC,EAAuC;AACrC,YAAMD,gBAAN;AACD;AACF;;AAxE8C,CAAjD","sourcesContent":["/**\n * Module to create a health check object that pings a URL.\n */\n\n'use strict';\n\nimport Base from './base';\nimport is from 'ramda/src/is';\nimport superagent from 'superagent';\n\n/**\n * Class representing a single health check that pings a URL.\n */\nmodule.exports = class HTTPUrlCheck extends Base {\n  /**\n   * Create a ping URL health check. Accepts the same options as Base, but with a few additions.\n   * @param {Object} options - The health check options.\n   * @param {String} [options.method=HEAD] - The method to use when pinging the URL.\n   * @param {String} options.url - The URL to ping when the health check runs.\n   * @throws {TypeError} Will throw if any options are invalid.\n   */\n  constructor(options) {\n    HTTPUrlCheck.assertOptionValidity(options);\n    super(options);\n  }\n\n  /**\n   * Actually perform the health check. This updates the relevant properties.\n   * @returns {Promise} A promise which resolves with undefined.\n   */\n  async run() {\n    const url = typeof this.options.url === 'function' ? this.options.url() : this.options.url;\n    const response = await superagent(this.options.method || 'GET', url)\n      .set({\n        'cache-control': 'no-cache, no-store, must-revalidate',\n        pragma: 'no-cache',\n        expires: '0',\n        ...this.options.headers,\n      })\n      .timeout(this.options.interval)\n      .retry(this.options.retry || 2)\n      .then(() => {\n        this.ok = true;\n        this.checkOutput = 'success';\n        this.lastUpdated = new Date();\n        console.info(`Health check \"${this.options.name}\" succeeded`);\n      })\n      .catch((error) => {\n        this.ok = false;\n        this.checkOutput = error.message;\n        this.lastUpdated = new Date();\n        console.error(`Health check \"${this.options.name}\" failed: ${error.message}`);\n      });\n\n    return response;\n  }\n\n  /**\n   * Validate health check options against the standard.\n   * @param {Object} options - The options to check.\n   * @returns {(Boolean|TypeError)} Will return `true` if the options are valid, or a descriptive error if not.\n   */\n  static validateOptions(options) {\n    if (!is(Object, options)) {\n      return new TypeError('Options must be an object');\n    }\n    if (!is(Function, options.url) && (!is(String, options.url) || !options.url.trim())) {\n      return new TypeError('Invalid option: url must be a non-empty string or a function');\n    }\n    if (options.headers !== undefined && !is(Object, options.headers)) {\n      return new TypeError('Invalid option: headers must be an object');\n    }\n    return true;\n  }\n\n  /**\n   * Assert that health check options are valid.\n   * @param {Object} options - The options to assert validity of.\n   * @throws {TypeError} Will throw if the options are invalid.\n   */\n  static assertOptionValidity(options) {\n    const validationResult = HTTPUrlCheck.validateOptions(options);\n    if (validationResult instanceof Error) {\n      throw validationResult;\n    }\n  }\n};\n"],"file":"http.js"}