{"version":3,"sources":["../../src/check/base.js"],"names":["defaults","require","isFinite","isPlainObject","isString","module","exports","Check","constructor","options","defaultOptions","assertOptionValidity","log","businessImpact","id","interval","name","panicGuide","severity","technicalSummary","checkOutput","ok","lastUpdated","Date","start","isRunning","Error","run","_interval","setInterval","bind","unref","stop","clearInterval","Boolean","status","toJSON","filter","check","every","Promise","resolve","toISOString","inspect","validateOptions","TypeError","option","requiredOptions","undefined","trim","test","validationResult","console","Set"],"mappings":"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","sourcesContent":["/**\n * Module to create a health check object.\n */\n'use strict';\n\nconst defaults = require('lodash/defaults');\nconst isFinite = require('lodash/isFinite');\nconst isPlainObject = require('lodash/isPlainObject');\nconst isString = require('lodash/isString');\n\n/**\n * Class representing a single health check.\n */\nmodule.exports = class Check {\n  /**\n   * Create a health check. The options used here are documented in the Health check standard:\n   * @param {Object} options - The health check options.\n   * @param {String} options.businessImpact - The business impact of the health check.\n   * @param {String} options.id - The unique ID of the health check. Must use only lowercase alphanumeric characters and hyphens.\n   * @param {Number} [options.interval=30000] - The number of milliseconds to wait between checks.\n   * @param {Object} [options.log=console] - A logging object.\n   * @param {Function} [options.log.error] - A function to log error level messages.\n   * @param {String} options.name - The name of the health check.\n   * @param {String} options.panicGuide - The panic guide for the health check.\n   * @param {Number} [options.severity=1] - The severity level of the health check if it is failing. Must be one of 1 (high), 2 (medium), 3 (low).\n   * @param {String} options.technicalSummary - The technical summary for the health check.\n   * @throws {TypeError} Will throw if any options are invalid.\n   */\n  constructor(options) {\n    this.options = defaults({}, options, Check.defaultOptions);\n    Check.assertOptionValidity(this.options);\n    this.log = this.options.log;\n\n    // Save output options to properties\n    this.businessImpact = this.options.businessImpact;\n    this.id = this.options.id;\n    this.interval = this.options.interval;\n    this.name = this.options.name;\n    this.panicGuide = this.options.panicGuide;\n    this.severity = this.options.severity;\n    this.technicalSummary = this.options.technicalSummary;\n\n    // Set defaults\n    this.checkOutput = '';\n    this.ok = true;\n    this.lastUpdated = new Date();\n  }\n\n  /**\n   * Start running the health check.\n   * @throws {Error} Will throw if the health check is already running.\n   */\n  async start() {\n    if (this.isRunning()) {\n      throw new Error('The check has already been started');\n    }\n    await this.run();\n    if (this.options.interval) {\n      this._interval = setInterval(this.run.bind(this), this.options.interval);\n      this._interval.unref();\n    }\n  }\n\n  /**\n   * Stop running the health check.\n   * @throws {Error} Will throw if the health check is not running.\n   */\n  stop() {\n    if (!this.isRunning()) {\n      throw new Error('The check has not been started');\n    }\n\n    if (this.options.interval) {\n      clearInterval(this._interval);\n      delete this._interval;\n    }\n  }\n\n  /**\n   * Check whether the check is currently running.\n   * @returns {Boolean} Returns whether the check is running.\n   */\n  isRunning() {\n    if (!this.options.interval) {\n      return Boolean(this._interval);\n    }\n\n    throw new Error('The interval option is missing therefore nothing is currently running');\n  }\n\n  /**\n   * Actually perform the health check. This updates the relevant properties.\n   * @returns {Promise} A promise which resolves with undefined.\n   */\n  run() {\n    throw new Error('The Check class must be extended rather than used directly');\n  }\n\n  /**\n   * Get a status\n   * @returns {Function} A function which returns a promise that resolves to a boolean indicating whether all the health checks are OK.\n   */\n  status() {\n    const ok = this.toJSON()\n      //false will be the resolved value if any of the health checks with severity 1 are failing.\n      .filter((check) => check.severity === 1)\n      .every((check) => check.ok);\n    return Promise.resolve(ok);\n  }\n\n  /**\n   * Get a JSON representation of the health check.\n   * @access private\n   * @returns {Object} The health check as a JSON-friendly object.\n   */\n  toJSON() {\n    return {\n      id: this.id,\n      name: this.name,\n      ok: this.ok,\n      severity: this.severity,\n      businessImpact: this.businessImpact,\n      technicalSummary: this.technicalSummary,\n      panicGuide: this.panicGuide,\n      checkOutput: this.checkOutput,\n      lastUpdated: this.lastUpdated.toISOString(),\n    };\n  }\n\n  /**\n   * Get console-friendly representation of the health check.\n   * @access private\n   * @returns {String} The console-friendly representation.\n   */\n  inspect() {\n    return `${this.constructor.name} [${this.ok ? 'OK' : 'NOT OK'}] ${\n      this.name\n    } (updated ${this.lastUpdated.toISOString()})`;\n  }\n\n  /**\n   * Validate health check options against the standard.\n   * @param {Object} options - The options to check.\n   * @returns {(Boolean|TypeError)} Will return `true` if the options are valid, or a descriptive error if not.\n   */\n  static validateOptions(options) {\n    if (!isPlainObject(options)) {\n      return new TypeError('Options must be an object');\n    }\n    for (const option of module.exports.requiredOptions) {\n      if (options[option] === undefined) {\n        return new TypeError(`Missing required option: ${option}`);\n      }\n    }\n    if (!isString(options.businessImpact) || !options.businessImpact.trim()) {\n      return new TypeError('Invalid option: businessImpact must be a non-empty string');\n    }\n    if (!isString(options.id) || !/^[a-z0-9\\-]+$/.test(options.id)) {\n      return new TypeError('Invalid option: id must be lowercase and alphanumeric with hyphens');\n    }\n    if (!isString(options.name) || !options.name.trim()) {\n      return new TypeError('Invalid option: name must be a non-empty string');\n    }\n    if (!isString(options.panicGuide) || !options.panicGuide.trim()) {\n      return new TypeError('Invalid option: panicGuide must be a non-empty string');\n    }\n    if (!isFinite(options.severity) || options.severity < 1 || options.severity > 3) {\n      return new TypeError('Invalid option: severity must be 1, 2, or 3');\n    }\n    if (!isString(options.technicalSummary) || !options.technicalSummary.trim()) {\n      return new TypeError('Invalid option: technicalSummary must be a non-empty string');\n    }\n    return true;\n  }\n\n  /**\n   * Assert that health check options are valid.\n   * @param {Object} options - The options to assert validity of.\n   * @throws {TypeError} Will throw if the options are invalid.\n   */\n  static assertOptionValidity(options) {\n    const validationResult = Check.validateOptions(options);\n    if (validationResult instanceof Error) {\n      throw validationResult;\n    }\n  }\n};\n\n/**\n * Check option defaults. This will be merged with user options.\n * @access private\n */\nmodule.exports.defaultOptions = {\n  interval: 30000,\n  log: console,\n  severity: 1,\n};\n\n/**\n * A list of options that are required.\n * @access private\n */\nmodule.exports.requiredOptions = new Set([\n  'businessImpact',\n  'id',\n  'interval',\n  'name',\n  'panicGuide',\n  'severity',\n  'technicalSummary',\n]);\n"],"file":"base.js"}