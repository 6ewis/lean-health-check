{"version":3,"sources":["../src/index.js"],"names":["Base","require","defaults","module","exports","HealthCheck","constructor","options","defaultOptions","runAllHealthCheck","checkObjects","Promise","all","checks","map","checkOptions","log","Object","prototype","hasOwnProperty","call","checkTypeMap","type","TypeError","CheckTypeClass","healthCheck","start","status","ok","toJSON","filter","check","severity","every","console","resolve","stop","forEach","isRunning","inspect","unshift","name","push","join","http","Check"],"mappings":"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","sourcesContent":["/**\n * Module to build health check functions which comply with the FT health check standard.\n * @module @altruist/health-check\n */\n'use strict';\n\nconst Base = require('./check/base');\nconst defaults = require('lodash/defaults');\n\n/**\n * Class representing a set of health checks.\n */\nmodule.exports = class HealthCheck {\n  /**\n   * Create a health check set.\n   * @param {Object} options - The health check set options.\n   * @param {Array} options.checks - An array of health check configurations.\n   * @param {Object} [options.log=console] - A logging object.\n   * @throws {TypeError} Will throw if any options are invalid.\n   */\n  constructor(options) {\n    this.options = defaults({}, options, HealthCheck.defaultOptions);\n  }\n\n  async runAllHealthCheck() {\n    this.checkObjects = await Promise.all(\n      this.options.checks.map(async (checkOptions) => {\n        checkOptions.log = this.options.log;\n\n        if (!Object.prototype.hasOwnProperty.call(HealthCheck.checkTypeMap, checkOptions.type)) {\n          throw new TypeError(`Invalid check type: ${checkOptions.type}`);\n        }\n\n        const CheckTypeClass = HealthCheck.checkTypeMap[checkOptions.type];\n        const healthCheck = new CheckTypeClass(checkOptions);\n        await healthCheck.start();\n        return healthCheck;\n      }),\n    );\n\n    this.log = this.options.log;\n  }\n\n  /**\n   * Get a status\n   * @returns a promise that resolves to a boolean indicating whether all the health checks are OK.\n   */\n  async status() {\n    await this.runAllHealthCheck();\n    const ok = this.toJSON()\n      //false will be the resolved value if any of the health checks with severity 1 are failing.\n      .filter((check) => check.severity === 1)\n      .every((check) => check.ok);\n    console.log(\"check\", ok);\n    return Promise.resolve(ok);\n  }\n\n  /**\n   * Stop all of the checks from running, calling the `stop` method of each.\n   * @returns {undefined}\n   */\n  stop() {\n    this.checkObjects.forEach((check) => {\n      if (check.isRunning()) {\n        check.stop();\n      }\n    });\n  }\n\n  /**\n   * Get a JSON representation of the health check set.\n   * @access private\n   * @returns {Object} The health check set as a JSON-friendly object.\n   */\n  toJSON() {\n    return this.checkObjects.map((check) => check.toJSON());\n  }\n\n  /**\n   * Get console-friendly representation of the health check set.\n   * @access private\n   * @returns {String} The console-friendly representation.\n   */\n  inspect() {\n    const inspect = this.checkObjects.map((check) => `  ${check.inspect()}`);\n    inspect.unshift(`${this.constructor.name} {`);\n    inspect.push('}');\n    return inspect.join('\\n');\n  }\n};\n\n/**\n * HealthCheck option defaults. This will be merged with user options.\n * @access private\n */\nmodule.exports.defaultOptions = {\n  checks: [],\n  log: console,\n};\n\n/**\n * HealthCheck type to class map.\n * @access private\n */\nmodule.exports.checkTypeMap = {\n  get http() {\n    return require('./check/http');\n  },\n};\n\n/**\n * HealthCheck Base class.\n * @access public\n */\nmodule.exports.Check = Base;\n"],"file":"index.js"}